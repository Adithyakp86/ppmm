name: Release (crates.io + binaries + packages)

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: release

    permissions:
      id-token: write
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: actions/setup-rust@v1
        with:
          toolchain: stable

      - name: Install zip & deb tools
        run: sudo apt-get update && sudo apt-get install -y zip dpkg-dev

      - name: Verify project builds
        run: cargo build --release

      - name: Test before publishing
        run: cargo test

      - name: Publish to crates.io
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Build release binaries
        run: |
          VERSION=${GITHUB_REF##*/}          # v1.0.0
          VERSION=${VERSION#v}              # 1.0.0

          mkdir -p releases/windows releases/linux releases/macos

          # Linux build
          cargo build --release
          cp target/release/ppmm releases/linux/ppmm-linux-x64

          # Windows build
          rustup target add x86_64-pc-windows-gnu
          cargo build --release --target x86_64-pc-windows-gnu
          cp target/x86_64-pc-windows-gnu/release/ppmm.exe releases/windows/ppmm-windows-x64.exe

          # macOS build
          rustup target add x86_64-apple-darwin
          cargo build --release --target x86_64-apple-darwin
          cp target/x86_64-apple-darwin/release/ppmm releases/macos/ppmm-macos-x64

      - name: Zip Windows binary
        run: |
          cd releases/windows
          zip -r ppmm-windows-x64.zip ppmm-windows-x64.exe
          cd ../..

      - name: Build .deb package
        run: |
          VERSION=${GITHUB_REF##*/}          # v1.0.0
          VERSION=${VERSION#v}              # 1.0.0

          mkdir -p build/DEBIAN build/usr/bin
          cargo build --release
          cp target/release/ppmm build/usr/bin/ppmm
          cp packaging/deb/control build/DEBIAN/control

          dpkg-deb --build build ppmm_${VERSION}_amd64.deb

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            releases/windows/ppmm-windows-x64.zip
            releases/linux/ppmm-linux-x64
            releases/macos/ppmm-macos-x64
            ppmm_${{ github.ref_name#v }}_amd64.deb

      - name: Generate winget manifest
        run: |
          VERSION=${GITHUB_REF##*/}          # v1.0.0
          VERSION=${VERSION#v}              # 1.0.0

          SHA256=$(sha256sum releases/windows/ppmm-windows-x64.zip | awk '{print $1}')
          mkdir -p packaging/winget

          cat > packaging/winget/ppmm.yaml <<EOL
Id: Sumangal44.ppmm
Name: ppmm
Version: $VERSION
Publisher: Sumangal44
License: MIT
ShortDescription: Python Project Manager CLI
Installers:
  - Architecture: x64
    InstallerType: portable
    InstallerUrl: https://github.com/Sumangal44/ppmm/releases/download/v$VERSION/ppmm-windows-x64.zip
    InstallerSha256: $SHA256
EOL

      - name: Upload winget manifest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifest
          path: packaging/winget/ppmm.yaml
